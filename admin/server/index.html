<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../img/logo/neighborhood/favicon.png">
    <title>Configure Your Local Server</title>

    <link type="text/css" rel="stylesheet" href="../../../localsite/css/base.css" id="/localsite/css/base.css" />
    <script type="text/javascript" src="../../../localsite/js/localsite.js?showheader=true"></script>

    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/shared-styles.css">
    <script src="../../js/setup.js"></script>
    
    <!-- Side Nav -->
    <link rel="stylesheet" href="../../../localsite/css/nav.css">
    <script src="../../../localsite/js/nav.js"></script>
    <style>
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="breadcrumb">
            <a href="../">Partner Tools</a>
        </div>

        <div class="header">
            <h1>
                <div class="gemini-icon">C</div>
                Configure Your Local Server
                <!-- Google Gemini Insights -->
            </h1>
            <p><a href="../../projects/#list=all">Our Data Insights Page</a> let's you send a dataset to Claude and Gemini for analysis when <a href="../">running the site locally</a>.</p>
        </div>

        <div class="card" id="textInPage">
          <div id="webrootSetup"></div>
        </div>

        <div id="os-detection-container"></div>

        <div class="card" id="web-server-panel">
            <h2 class="card-title">
                <span class="status-indicator" id="web-server-status"></span>
                <span id="web-server-title">Local Web Server</span>
            </h2>
            <div id="web-server-content">
                <p style="color: var(--text-secondary);">
                    Checking web server status...
                </p>
            </div>
        </div>

        <div id="combined-rust-api-container"></div>



        <div class="card">
            <h2 class="card-title">About AI Insights</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Both Claude Code CLI and the Gemini API can be applied for <a href="../../projects/#list=all">data analysis</a><!--, content generation, 
                and smart recommendations for CRM activities.-->
            </p>
            
            <div class="info-grid">
                <div class="info-item">
                    <strong>API Key Requirements:</strong><br>
                    Google Cloud project with Gemini API enabled
                </div>
                <div class="info-item">
                    <strong>Environment Variable:</strong><br>
                    GEMINI_API_KEY in your .env file
                </div>
                <div class="info-item">
                    <strong>API Endpoint:</strong><br>
                    generativelanguage.googleapis.com
                </div>
            </div>

            <div class="warning-message" style="display:none">
                <strong>Security Note:</strong> Your API key is never displayed in full. Only the first 4 and last 4 characters are shown for verification.
            </div>

            <div style="margin-top: 20px;">
                <a href="../../projects/#list=all&insights=all" class="btn" style="background-color: var(--accent-green); color: white; border: none;">
                    <i data-feather="search"></i>
                    Gather Insights
                </a>
            </div>
        </div>

        <div id="readmeDiv" class="card readme-content" style="display:none">
            <p style="color: var(--text-secondary); font-style: italic;">
                Loading README.md documentation...
            </p>
        </div>
    </div>

    <script src="../../js/common.js"></script>
    <script>
        const GEMINI_API_BASE = 'http://localhost:8081/api';
        
        
        // Web Server panel elements
        const webServerPanel = document.getElementById('web-server-panel');
        const webServerStatus = document.getElementById('web-server-status');
        const webServerTitle = document.getElementById('web-server-title');
        const webServerContent = document.getElementById('web-server-content');

        // Update Web Server panel status
        function updateWebServerPanel() {
            const currentHost = window.location.hostname;
            const currentPort = window.location.port;
            const isLocalhost8887 = currentHost === 'localhost' && currentPort === '8887';
            
            if (isLocalhost8887) {
                webServerStatus.className = 'status-indicator connected';
                webServerTitle.textContent = 'Web Server Running';
                const currentUrl = window.location; // window.location.origin
                webServerContent.innerHTML = `
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        ‚úÖ Your local http server is <a href="${currentUrl}" style="color: var(--accent-blue); text-decoration: underline;">${currentUrl}</a>
                    </p>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="showWebserverCommand()">
                            Webserver Command
                        </button>
                    </div>
                `;
            } else {
                webServerStatus.className = 'status-indicator loading'; // grey dot for non-localhost
                webServerTitle.textContent = 'Local Web Server';
                webServerContent.innerHTML = `
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        To contribute code, view at <a href="https://localhost:8887/team/admin/server">localhost:8887/team/admin/server</a>. 
                        If your localhost server is not started, click to copy commands:
                    </p>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="showWebserverCommand()">
                            Start my local server
                        </button>
                    </div>
                `;
            }
        }

        // Show webserver command instructions
        function showWebserverCommand() {
            webServerContent.innerHTML = `
                <div id="webserver-command-content">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Webserver setup instructions and commands:
                    </p>
                    <div id="claude-webserver-status"></div>
                    <button class="btn btn-secondary" onclick="updateWebServerPanel()" style="margin-top: 16px;">
                        ‚Üê Back to Status
                    </button>
                </div>
            `;
            
            // Load webserver status content
            setTimeout(() => {
                loadWebServerStatus("claude-webserver-status");
            }, 100);
        }


        // Parse .env file content
        function parseEnvFile(envText) {
            const config = {};
            const lines = envText.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed && !trimmed.startsWith('#')) {
                    const [key, ...valueParts] = trimmed.split('=');
                    if (key && valueParts.length > 0) {
                        const value = valueParts.join('=');
                        config[key.trim()] = value.trim();
                    }
                }
            }
            
            // Apply same validation logic as backend
            config.gemini_api_key_present = !!(config.GEMINI_API_KEY && 
                config.GEMINI_API_KEY !== 'dummy_key' && 
                config.GEMINI_API_KEY !== 'get-key-at-aistudio.google.com');
                
            return config;
        }



        // Load README content for setup instructions
        function loadWebServerStatus(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Always show README content for local setup (web server status is now in its own panel)
            const readmeId = `${containerId}-readme`;
            container.innerHTML = `
                <h3 style="margin-bottom: 16px; color: var(--text-primary);">üõ°Ô∏è Run Webserver Locally</h3>
                <div id="${readmeId}" class="readme-content">
                    <p style="color: var(--text-secondary); font-style: italic;">
                        Loading README.md...
                    </p>
                </div>
            `;
            
            // Load README content
            setTimeout(() => {
                displayFile("../README.md", readmeId, "_parent", null, false);
            }, 50);
        }

        // Show connection help (now displayed as a separate card below)
        function showConnectionHelp() {
            // Connection troubleshooting is now shown as a separate card on the page
            // No longer need to add inline help since it's always visible
        }

        // Create .env file from .env.example
        async function createEnvFromExample() {
            try {
                // First, try to read .env.example
                const exampleResponse = await fetch('../../.env.example');
                if (!exampleResponse.ok) {
                    throw new Error('.env.example file not found');
                }
                
                const exampleContent = await exampleResponse.text();
                
                // Try to create .env file via backend
                const createResponse = await fetch(`${GEMINI_API_BASE}/config/create-env`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: exampleContent
                    })
                });
                
                if (createResponse.ok) {
                    // Successfully created .env file
                    const configDisplay = document.getElementById('config-display');
                    if (configDisplay) configDisplay.innerHTML = `
                        <div style="color: var(--accent-green); margin-bottom: 16px;">
                            ‚úÖ Created .env file from .env.example template
                        </div>
                        <strong>Configuration Source:</strong> .env file (newly created)<br>
                        <strong>Gemini API Key:</strong> <span style="color: var(--accent-red);">Needs to be configured</span><br>
                    `;
                    
                    // Show the Gemini key input field
                    geminiKeyContainer.style.display = 'block';
                    geminiKeyContainer.innerHTML = `
<div style="margin: 16px 0; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-light);">
    <strong>Enter Your Gemini API Key:</strong>
    <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
        <input type="text" id="gemini-key-input" placeholder="AIzaSy..." 
               style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-family: monospace;">
        <button id="save-key-btn" class="btn btn-primary" onclick="saveGeminiKey()">Save</button>
    </div>
    <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
        Get your API key from <a href="https://aistudio.google.com" target="_blank" style="color: var(--accent-blue);">Google AI Studio</a>
    </div>
</div>`;
                    
                    // Add enter key listener
                    setTimeout(() => {
                        const keyInput = document.getElementById('gemini-key-input');
                        if (keyInput) {
                            keyInput.addEventListener('keypress', function(e) {
                                if (e.key === 'Enter') {
                                    saveGeminiKey();
                                }
                            });
                        }
                    }, 100);
                    
                } else {
                    throw new Error('Failed to create .env file via backend');
                }
                
            } catch (error) {
                // Failed to create .env file
                configDisplay.innerHTML = `
                    <div style="color: var(--accent-red); margin-bottom: 16px;">
                        ‚ùå Could not create .env file automatically
                    </div>
                    <strong>Issue:</strong> ${error.message}<br><br>
                    <strong>Manual Setup Required:</strong><br>
                    1. Copy .env.example to .env<br>
                    2. Edit the GEMINI_API_KEY value<br>
                    3. Start the backend server<br>
                    Or run locally using the commands on our <a href="../admin" style="color: var(--accent-blue); text-decoration: underline;">Admin Page</a>
                `;
                
                // Show connection help for troubleshooting
                showConnectionHelp();
                
                console.error('Failed to create .env from example:', error);
            }
        }




        // Use shared OS detection panel from team/js/common.js
        createOSDetectionPanel('os-detection-container');

        // Use shared combined Rust API Status panel from team/js/common.js
        createRustApiStatusPanel('combined-rust-api-container', false);

        // Setup webroot setup content
        if (typeof setupWebrootSetup === 'function') {
            setupWebrootSetup('webrootSetup');
        } else {
            console.error('setupWebrootSetup function not available');
        }
        
        // Initialize page
        updateWebServerPanel(); // Check web server status
        
        // Use shared processPCContent function from team/js/common.js
        function processServerPCContent() {
            const osSelect = document.getElementById('os');
            const osValue = osSelect ? osSelect.value : null;
            processPCContent(osValue);
        }
        
        // Load README without logging to keep the interface clean
        //displayFile("README.md", "readmeDiv", "_parent", null, false, processServerPCContent);
    </script>
    
    <!-- Feather icons handled by nav.js -->
</body>
</html>