<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title id="page-title">Database Edit Test</title>
    <link rel="icon" type="image/x-icon" href="../img/logo/neighborhood/favicon.png">
    
    <link type="text/css" href="../../localsite/css/base.css" rel="stylesheet" />
    <script type="text/javascript" src="../../localsite/js/localsite.js?showheader=true&showsearch=false"></script>
    <script src="../js/common.js"></script>
    
    <!-- Feather icons handled by nav.js -->
    <!-- Side Nav -->
    <link rel="stylesheet" href="../../localsite/css/nav.css">
    <script src="../../localsite/js/nav.js?shownav=false"></script>
    <style>
        body {
            line-height: 2.5em;
            margin: 30px;
        }
        input {
            min-width: 250px;
        }
        input[name="total_participants"] {
            width: 60px !important;
            height: 32px !important;
            min-width: 60px !important;
        }
        input[type="date"] {
            width: 120px !important;
            height: 32px !important;
            min-width: 100px !important;
        }
        .form-field.project-name-field,
        .form-field.location-field {
            overflow: auto;
        }
        .form-field.project-name-field .form-value,
        .form-field.location-field .form-value {
            width: calc(100% - 165px);
        }
        @media (max-width: 700px) {
            .form-field.project-name-field .form-label,
            .form-field.location-field .form-label {
                float: none;
                margin-bottom: 5px;
            }
            .form-field.project-name-field .form-value,
            .form-field.location-field .form-value {
                float: none;
                width: 100%;
            }
        }
        input[name="name"],
        input[name="location"] {
            height: 32px !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        .form-field.description-field {
            overflow: auto;
        }
        /* Wide form field styles */
        .form-field.wide-field .form-value {
            width: calc(100% - 165px);
        }
        
        @media (max-width: 700px) {
            .form-field.wide-field .form-label {
                float: none !important;
                margin-bottom: 5px;
            }
            .form-field.wide-field .form-value {
                float: none !important;
                width: 100% !important;
            }
        }
        .form-field.participant-handles-field {
            overflow: auto;
            display: none; /* Hidden by default */
            position: relative;
            z-index: 1;
        }
        .form-field.participant-handles-field.localhost {
            display: block; /* Show only on localhost */
        }
        .form-field.participant-handles-field .form-value {
            width: calc(100% - 165px);
        }
        .form-field.participant-names-field {
            overflow: auto;
            position: relative;
            z-index: 10;
        }
        .form-field.participant-names-field .form-value {
            width: calc(100% - 165px);
        }
        
        /* Name lookup styles */
        .name-lookup-container {
            position: relative;
        }
        .name-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
        }
        .name-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .name-suggestion:hover,
        .name-suggestion.active {
            background: #f8f9fa;
        }
        .name-suggestion:last-child {
            border-bottom: none;
        }
        .dark .name-suggestions {
            background: #2d2d2d;
            border-color: #404040;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .dark .name-suggestion {
            border-bottom-color: #404040;
            color: #e0e0e0;
        }
        .dark .name-suggestion:hover,
        .dark .name-suggestion.active {
            background: #333;
        }

        /* Location lookup styles */
        .location-lookup-container {
            position: relative;
        }
        .location-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
        }
        .location-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .location-suggestion:hover,
        .location-suggestion.active {
            background: #f8f9fa;
        }
        .location-suggestion:last-child {
            border-bottom: none;
        }
        .dark .location-suggestions {
            background: #2d2d2d;
            border-color: #404040;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }
        .dark .location-suggestion {
            border-bottom-color: #404040;
            color: #e0e0e0;
        }
        .dark .location-suggestion:hover,
        .dark .location-suggestion.active {
            background: #333;
        }

        textarea[name="participant_handles"],
        textarea[name="participant_names"],
        textarea[name="participant_emails"] {
            width: 100% !important;
            padding: 10px !important;
            box-sizing: border-box !important;
        }
        .tip-text {
            font-size: 0.85em;
            color: #666;
            font-style: italic;
            margin-top: 3px;
        }
        textarea[name="description"] {
            width: 100% !important;
            padding: 10px !important;
            box-sizing: border-box !important;
        }
        .form-field {
            margin-bottom: 15px;
            overflow: auto;
        }
        .form-label {
            min-width: 155px;
            float: left;
            font-weight: bold;
            padding-top: 5px;
            padding-right: 10px;
        }
        .form-value {
            float: left;
            overflow: auto;
        }
        #upIconTray, #sideIcons {
            display: none !important;
        }
        #connection-status {
            display: none;
        }
        #connection-status.localhost {
            display: block;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .header-controls #connection-status {
            flex: 1;
        }
        .add-visit-btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 20px;
        }
        
        /* Header Toggle Buttons */
        .header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .view-toggle-btn {
            padding: 8px 16px;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .view-toggle-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            text-decoration: none;
            color: #333;
        }
        
        .view-toggle-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .view-toggle-btn.active:hover {
            background: #0056b3;
            border-color: #0056b3;
            color: white;
        }
        
        /* Content Sections */
        .content-section {
            display: none;
            margin-top: 20px;
        }
        
        .content-section.active {
            display: block;
        }

        /* Projects List Styles */
        .projects-section {
            margin-top: 20px;
            padding-top: 20px;
        }
        
        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .projects-header h2 {
            margin: 0;
        }
        
        .section-actions {
            display: flex;
            gap: 10px;
        }
        
        .section-action-btn {
            padding: 8px 16px;
            background: #28a745;
            color: white !important;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .section-action-btn:hover {
            background: #218838;
            color: white;
            text-decoration: none;
        }
        
        .section-action-btn.insights {
            background: #6f42c1;
            color: white;
        }
        
        .section-action-btn.insights:hover {
            background: #5a359e;
            color: white;
        }
        
        @media (max-width: 768px) {
            .header-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .header-buttons {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .view-toggle-btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .projects-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .section-actions {
                gap: 5px;
            }
            
            .section-action-btn {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
        }
        
        .projects-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .project-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .project-item:hover {
            background: #f8f9fa;
        }
        
        .project-item:last-child {
            border-bottom: none;
        }
        
        .project-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .project-details {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 12px;
        }
        
        .project-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .project-info {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.85rem;
            color: #888;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-included {
            background: #d4edda;
            color: #155724;
        }
        
        .status-review {
            background: #fff3cd;
            color: #856404;
        }
        
        .edit-btn {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .edit-btn:hover {
            background: #0056b3;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px 0;
        }
        
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .pagination-btn:hover:not(.disabled) {
            background: #f8f9fa;
            border-color: #007bff;
            color: #007bff;
            text-decoration: none;
        }
        
        .pagination-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-info {
            color: #666;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .no-projects {
            text-align: center;
            padding: 40px;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        /* Dark Mode Styles */
        .dark body {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .dark .form-field {
            color: #e0e0e0;
        }
        
        .dark input, .dark textarea, .dark select {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border-color: #404040;
        }
        
        .dark input:focus, .dark textarea:focus, .dark select:focus {
            border-color: #007bff;
            outline: none;
        }
        
        .dark .projects-list {
            background: #2d2d2d;
            border-color: #404040;
        }
        
        .dark .project-item {
            border-bottom-color: #404040;
        }
        
        .dark .project-item:hover {
            background: #333;
        }
        
        .dark .project-title {
            color: #e0e0e0;
        }
        
        .dark .project-details {
            color: #b0b0b0;
        }
        
        .dark .project-info {
            color: #888;
        }
        
        .dark .pagination-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e0e0e0;
        }
        
        .dark .pagination-btn:hover:not(.disabled) {
            background: #333;
        }
        
        .dark .pagination-btn.active {
            background: #007bff;
            border-color: #007bff;
        }
        
        .dark .no-projects {
            background: #2d2d2d;
            color: #b0b0b0;
        }
        
        .dark .tip-text {
            color: #888;
        }
        
        .dark h1, .dark h2 {
            color: #e0e0e0;
        }
        
        .dark .view-toggle-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e0e0e0;
        }
        
        .dark .view-toggle-btn:hover {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }
        
        .dark .view-toggle-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .dark .view-toggle-btn.active:hover {
            background: #0056b3;
            border-color: #0056b3;
            color: white;
        }
        
        .dark .header-controls {
            border-bottom-color: #404040;
        }
        
        .dark .section-action-btn {
            /* Keep same colors in dark mode for good contrast */
        }
        
        .dark .section-action-btn:hover {
            /* Keep same hover colors in dark mode */
        }
        
        .dark-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            background: #333;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            z-index: 1000;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .dark-toggle:hover {
            background: #555;
        }
        
        .dark-toggle i {
            width: 16px;
            height: 16px;
        }
        
        @media (max-width: 768px) {
            .project-meta {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .project-info {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>

</head>
<body>

<button class="dark-toggle" onclick="toggleDarkMode()">
    <i data-feather="toggle-left" id="toggle-icon"></i>
    <span id="toggle-text">Dark</span>
</button>

<div id="formHolder" class="content contentpadding">

    <div class="header-controls">
        <div id="connection-status">
            <p>Checking database connection...</p>
        </div>
        <div class="header-buttons">
            <button class="view-toggle-btn active" id="add-new-btn" onclick="addNewProject()">
                <span id="add-new-text">Add Project</span>
            </button>
            <button class="view-toggle-btn" id="view-projects-btn" onclick="showProjectsView()">
                <span id="view-projects-text">View Projects</span>
            </button>
            <button class="view-toggle-btn" id="view-tables-btn" onclick="toggleTablesView()">
                <span id="tables-btn-text">View Tables</span>
            </button>
        </div>
    </div>

    <h1>Project</h1>
    
    <!-- Tables Section -->
    <div id="tables-section" class="content-section">
        <div id="tables-list"></div>
    </div>
    
    <!-- Projects Section -->
    <div id="projects-view-section" class="content-section">
        <div class="projects-section">
            <div class="projects-header">
                <h2 id="projects-header">All Projects</h2>
                <div class="section-actions">
                    <a href="map/#list=cities" class="section-action-btn">Show Map</a>
                    <a href="./" class="section-action-btn insights">Insights</a>
                </div>
            </div>
            <div id="projects-container">
                <div class="no-projects" id="projects-empty-state">Click "View Projects" above to load the projects list.</div>
            </div>
            <div id="pagination-container"></div>
        </div>
    </div>
    
    <form id="project-form">
        <div class="form-field project-name-field wide-field">
            <div class="form-label">Project Name</div>
            <div class="form-value"><input type="text" name="name" required></div>
        </div>
        <div class="form-field location-field wide-field">
            <div class="form-label">Location</div>
            <div class="form-value">
                <div class="location-lookup-container">
                    <input type="text" name="location" placeholder="Start typing city names...">
                </div>
                <div class="tip-text">Comma separated list. Type to search cities.</div>
                <div class="location-status" style="display: none; font-size: 12px; color: #999; margin-top: 4px;"></div>
            </div>
        </div>
        <div class="form-field description-field wide-field">
            <div class="form-label">Description</div>
            <div class="form-value"><textarea name="description"></textarea></div>
        </div>
        <div class="form-field participant-names-field wide-field">
            <div class="form-label">Names</div>
            <div class="form-value">
                <div class="name-lookup-container">
                    <textarea name="participant_names" placeholder="Start typing names to search..."></textarea>
                </div>
                <div class="tip-text">Comma separated list. Type to search team members.</div>
            </div>
        </div>
        <div class="form-field participant-emails-field wide-field">
            <div class="form-label">Emails</div>
            <div class="form-value">
                <textarea name="participant_emails" placeholder="Email addresses will be populated automatically..."></textarea>
                <div class="tip-text">Comma separated list. Populated automatically from Names field.</div>
            </div>
        </div>
        <div class="form-field participant-handles-field">
            <div class="form-label">Handles</div>
            <div class="form-value">
                <textarea name="participant_handles"></textarea>
                <div class="tip-text">Comma separated list. Example: bdole, jcarter</div>
            </div>
        </div>
        <div class="form-field">
            <div class="form-label">Total Participants</div>
            <div class="form-value"><input type="number" name="total_participants" value="1"></div>
        </div>
        <div class="form-field">
            <div class="form-label">Status</div>
            <div class="form-value">
                <select name="status">
                    <option value="Active">Active</option>
                    <option value="Included">Include on Map</option>
                    <option value="In Review">In Review</option>
                    <option value="Inactive">Inactive</option>        
                </select>
            </div>
        </div>
        <div class="form-field">
            <div class="form-label">Start Date</div>
            <div class="form-value"><input type="date" name="estimated_start_date"></div>
        </div>
        <div class="form-field">
            <div class="form-label">End Date</div>
            <div class="form-value"><input type="date" name="estimated_end_date"></div>
        </div>
        <button type="submit" class="btnX btn-primary add-visit-btn">Save Project</button>
    </form>
    
    <div id="form-result"></div>
</div>

<script>
    // Helper function to provide detailed error messages
    function getDetailedErrorMessage(errorMessage, data) {
        // Handle undefined or empty error messages
        if (!errorMessage || errorMessage === 'undefined' || errorMessage.trim() === '') {
            if (data && data.status === 'healthy') {
                return 'Server is running but database connection is not configured. Check your .env file settings.';
            }
            return 'Database connection failed with no error details provided. Server may be starting up or database credentials may be missing.';
        }
        
        // Handle common error patterns
        if (errorMessage.toLowerCase().includes('connection refused')) {
            return 'Database server is not running or refusing connections. Check if PostgreSQL is started and accessible.';
        }
        
        if (errorMessage.toLowerCase().includes('authentication') || errorMessage.toLowerCase().includes('password')) {
            return 'Database authentication failed. Check your username and password in the .env file.';
        }
        
        if (errorMessage.toLowerCase().includes('database') && errorMessage.toLowerCase().includes('does not exist')) {
            return 'The specified database does not exist. Create the database or check the database name in your .env file.';
        }
        
        if (errorMessage.toLowerCase().includes('timeout')) {
            return 'Database connection timed out. Check if the database server is running and network connectivity is available.';
        }
        
        // Return the original message if it's informative
        return errorMessage;
    }

    // CSV data URL for name lookup
    const CSV_DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRh5-bIR4hC1f9H3NtDCNT19hZXnqz8WRrBwTuLGnZiA5PWhFILUv2nS2FKE2TZ4dZ-RnJkZwHx1t2Y/pub?gid=1054734503&single=true&output=csv';
    
    // Store CSV data globally
    let csvData = [];
    
    // Parse CSV with proper quote handling
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        
        result.push(current.trim());
        return result;
    }
    
    // Load CSV data for name lookup
    async function loadCSVData() {
        try {
            const response = await fetch(CSV_DATA_URL);
            const csvText = await response.text();
            
            // Parse CSV data with proper quote handling
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length === 0) return;
            
            const headers = parseCSVLine(lines[0]).map(h => h.replace(/"/g, '').trim());
            
            csvData = lines.slice(1).map(line => {
                const values = parseCSVLine(line).map(v => v.replace(/"/g, '').trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                return obj;
            }).filter(obj => obj.Name && obj.Name.length > 0); // Filter out empty rows
            
            console.log('CSV data loaded:', csvData.length, 'entries');
            console.log('Sample data:', csvData.slice(0, 3));
        } catch (error) {
            console.error('Failed to load CSV data:', error);
        }
    }
    
    // Search names in CSV data (for model.earth) or teamLookup cache (for other sites)
    function searchNames(query) {
        if (!query || query.length < 2) return [];
        
        const modelsiteCookie = typeof Cookies !== 'undefined' ? Cookies.get('modelsite') : null;
        
        // For model.earth, use existing CSV data
        if (modelsiteCookie === 'model.earth') {
            const searchTerm = query.toLowerCase();
            return csvData.filter(person => 
                person.Name && person.Name.toLowerCase().includes(searchTerm)
            ).slice(0, 10); // Limit to 10 suggestions
        }
        
        // For other sites, use teamLookup cache directly
        if (typeof window.teamLookup !== 'undefined' && window.teamLookup[modelsiteCookie]) {
            const searchTerm = query.toLowerCase();
            const results = [];
            
            Object.values(window.teamLookup[modelsiteCookie]).forEach(member => {
                if (member.Name && member.Name.toLowerCase().includes(searchTerm)) {
                    results.push(member);
                }
            });
            
            return results.slice(0, 10); // Limit to 10 suggestions
        }
        
        // Try the searchTeamMembers function as fallback
        if (typeof searchTeamMembers === 'function') {
            return searchTeamMembers(query).slice(0, 10); // Limit to 10 suggestions
        }
        
        // Fallback: no results
        console.log('No search method available for current modelsite:', modelsiteCookie);
        return [];
    }
    
    // Show name suggestions
    function showNameSuggestions(suggestions, inputElement) {
        let suggestionsDiv = document.getElementById('name-suggestions');
        
        if (suggestions.length === 0) {
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            return;
        }
        
        // Create suggestions div if it doesn't exist or move it to body
        if (!suggestionsDiv || suggestionsDiv.parentElement !== document.body) {
            // Remove existing one if it's in the wrong place
            if (suggestionsDiv) {
                suggestionsDiv.remove();
            }
            
            suggestionsDiv = document.createElement('div');
            suggestionsDiv.id = 'name-suggestions';
            suggestionsDiv.className = 'name-suggestions';
            document.body.appendChild(suggestionsDiv);
        }
        
        const suggestionsHtml = suggestions.map(person => {
            // Try different possible handle field names
            const handle = person.Handle || person.handle || person.GitHub || person.github || person.Username || person.username || '';
            return `<div class="name-suggestion" data-name="${person.Name}" data-handle="${handle}">${person.Name}</div>`;
        }).join('');
        
        suggestionsDiv.innerHTML = suggestionsHtml;
        
        // Position the dropdown relative to the input field
        positionDropdown(suggestionsDiv, inputElement);
        suggestionsDiv.style.display = 'block';
        
        // Add click handlers
        suggestionsDiv.querySelectorAll('.name-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', function() {
                selectName(this.dataset.name, this.dataset.handle, inputElement);
            });
        });
    }
    
    // Select a name and update both Names and Handles fields
    function selectName(name, handle, inputElement) {
        const namesField = inputElement;
        const handlesField = document.querySelector('textarea[name="participant_handles"]');
        
        // Find the position where we're inserting
        const cursorPos = namesField.selectionStart;
        const textBeforeCursor = namesField.value.substring(0, cursorPos);
        const textAfterCursor = namesField.value.substring(cursorPos);
        
        // Find the current partial name being typed
        const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
        const currentQuery = textBeforeCursor.substring(lastCommaIndex + 1).trim();
        
        // Replace the current partial name with the selected name
        let beforeQuery = textBeforeCursor.substring(0, lastCommaIndex + 1);
        if (beforeQuery && beforeQuery !== ',') {
            beforeQuery += ' '; // Add space after comma if there's text before
        }
        
        // Build the new names value
        const newNamesValue = beforeQuery + name + textAfterCursor;
        namesField.value = newNamesValue;
        
        // Update emails and handles fields simultaneously
        const emailsField = document.querySelector('textarea[name="participant_emails"]');
        
        // Get team member data for email using teamLookup
        let email = '';
        const modelsiteCookie = typeof Cookies !== 'undefined' ? Cookies.get('modelsite') : null;
        
        // Try teamLookup cache directly first
        if (typeof window.teamLookup !== 'undefined' && window.teamLookup[modelsiteCookie]) {
            const memberData = window.teamLookup[modelsiteCookie][name.toLowerCase()];
            if (memberData && memberData.Email) {
                email = memberData.Email;
            }
        }
        
        // Fallback to getTeamMemberByName function if available
        if (!email && typeof getTeamMemberByName === 'function') {
            const memberData = getTeamMemberByName(name);
            if (memberData && memberData.Email) {
                email = memberData.Email;
            }
        }
        
        // Get current field values and split them
        let currentEmails = emailsField ? emailsField.value.split(',').map(e => e.trim()).filter(e => e) : [];
        let currentHandles = handlesField.value.split(',').map(h => h.trim()).filter(h => h);
        let currentNames = newNamesValue.split(',').map(n => n.trim()).filter(n => n);
        
        // Find the position of the newly added name
        const namePosition = currentNames.indexOf(name);
        
        // Add or update the email at the same position
        if (email && emailsField && namePosition !== -1) {
            // Ensure emails array is long enough
            while (currentEmails.length <= namePosition) {
                currentEmails.push('');
            }
            currentEmails[namePosition] = email;
            
            // Remove trailing empty emails
            while (currentEmails.length > 0 && currentEmails[currentEmails.length - 1] === '') {
                currentEmails.pop();
            }
            
            emailsField.value = currentEmails.join(', ');
        }
        
        // Add or update the handle at the same position (only for model.earth)
        if (handle && namePosition !== -1 && modelsiteCookie === 'model.earth') {
            // Ensure handles array is long enough
            while (currentHandles.length <= namePosition) {
                currentHandles.push('');
            }
            currentHandles[namePosition] = handle;
            
            // Remove trailing empty handles
            while (currentHandles.length > 0 && currentHandles[currentHandles.length - 1] === '') {
                currentHandles.pop();
            }
            
            handlesField.value = currentHandles.join(', ');
        }
        
        // Hide suggestions
        hideSuggestions();
        
        // Position cursor after the inserted name, ready for next entry
        const newCursorPos = (beforeQuery + name).length;
        setTimeout(() => {
            namesField.setSelectionRange(newCursorPos, newCursorPos);
            namesField.focus();
            
            // If there's no text after and we're not at the end, add a comma and space for next entry
            if (!textAfterCursor.trim() && newCursorPos === namesField.value.length) {
                const shouldAddComma = !namesField.value.endsWith(',') && !namesField.value.endsWith(', ');
                if (shouldAddComma) {
                    namesField.value += ', ';
                    namesField.setSelectionRange(namesField.value.length, namesField.value.length);
                }
            }
        }, 0);
    }
    
    // Position dropdown relative to input field
    function positionDropdown(suggestionsDiv, inputElement) {
        const rect = inputElement.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        suggestionsDiv.style.top = (rect.bottom + scrollTop) + 'px';
        suggestionsDiv.style.left = (rect.left + scrollLeft) + 'px';
        suggestionsDiv.style.width = rect.width + 'px';
    }
    
    // Hide suggestions helper function
    function hideSuggestions() {
        const suggestionsDiv = document.getElementById('name-suggestions');
        if (suggestionsDiv) {
            suggestionsDiv.style.display = 'none';
        }
    }
    
    // Handle participant names field - setup name lookup
    function setupNameLookup() {
        const namesField = document.querySelector('textarea[name="participant_names"]');
        
        if (!namesField) return;
        
        let searchTimeout;
        
        namesField.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            
            searchTimeout = setTimeout(() => {
                const modelsiteCookie = Cookies.get('modelsite');
                console.log('modelsite cookie value:', modelsiteCookie);
                
                // Get current query
                const cursorPos = this.selectionStart;
                const textBeforeCursor = this.value.substring(0, cursorPos);
                const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
                const currentQuery = textBeforeCursor.substring(lastCommaIndex + 1).trim();
                
                // Only do name lookup if modelsite is model.earth
                if (modelsiteCookie !== 'model.earth') {
                    // Try to load from localStorage cache if not in memory
                    if (typeof loadTeamLookupFromCache === 'function' && (!window.teamLookup || !window.teamLookup[modelsiteCookie])) {
                        const cachedData = loadTeamLookupFromCache(modelsiteCookie);
                        if (cachedData) {
                            if (!window.teamLookup) {
                                window.teamLookup = {};
                            }
                            if (!window.teamLookup[modelsiteCookie]) {
                                window.teamLookup[modelsiteCookie] = {};
                            }
                            Object.assign(window.teamLookup[modelsiteCookie], cachedData);
                        }
                    }
                    
                    // For non-model.earth sites, use teamLookup
                    if (currentQuery.length >= 2) {
                        const suggestions = searchNames(currentQuery);
                        showNameSuggestions(suggestions, this);
                    } else {
                        hideSuggestions();
                    }
                    return;
                }
                
                // For model.earth, use CSV data
                if (currentQuery.length >= 2) {
                    const suggestions = searchNames(currentQuery);
                    showNameSuggestions(suggestions, this);
                } else {
                    hideSuggestions();
                }
            }, 300);
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.name-lookup-container') && !e.target.closest('.name-suggestions')) {
                hideSuggestions();
            }
        });
        
        // Throttle function for scroll events
        let scrollTimeout;
        
        // Update dropdown position on scroll and resize
        window.addEventListener('scroll', function() {
            const suggestionsDiv = document.getElementById('name-suggestions');
            if (suggestionsDiv && suggestionsDiv.style.display === 'block') {
                // Clear existing timeout
                clearTimeout(scrollTimeout);
                
                // Check if input field is still visible
                const rect = namesField.getBoundingClientRect();
                const isVisible = rect.top >= 0 && rect.bottom <= window.innerHeight;
                
                if (isVisible) {
                    // Update position if still visible
                    positionDropdown(suggestionsDiv, namesField);
                } else {
                    // Hide if input field is out of view
                    hideSuggestions();
                }
            }
        }, { passive: true });
        
        window.addEventListener('resize', function() {
            const suggestionsDiv = document.getElementById('name-suggestions');
            if (suggestionsDiv && suggestionsDiv.style.display === 'block') {
                positionDropdown(suggestionsDiv, namesField);
            }
        });
        
        // Handle keyboard navigation
        namesField.addEventListener('keydown', function(e) {
            const suggestionsDiv = document.getElementById('name-suggestions');
            if (!suggestionsDiv || suggestionsDiv.style.display === 'none') return;
            
            const suggestions = suggestionsDiv.querySelectorAll('.name-suggestion');
            const activeSuggestion = suggestionsDiv.querySelector('.name-suggestion.active');
            
            if (e.key === 'Enter') {
                e.preventDefault();
                
                if (suggestions.length === 0) {
                    return; // No suggestions, do nothing
                }
                
                if (activeSuggestion) {
                    // Select the active suggestion
                    selectName(activeSuggestion.dataset.name, activeSuggestion.dataset.handle, this);
                } else if (suggestions.length === 1) {
                    // Auto-complete the single suggestion
                    const suggestion = suggestions[0];
                    selectName(suggestion.dataset.name, suggestion.dataset.handle, this);
                } else {
                    // Multiple suggestions, activate the first one
                    suggestions[0].classList.add('active');
                }
                return;
            }
            
            if (suggestions.length === 0) return;
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (activeSuggestion) {
                    activeSuggestion.classList.remove('active');
                    const next = activeSuggestion.nextElementSibling || suggestions[0];
                    next.classList.add('active');
                } else {
                    suggestions[0].classList.add('active');
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (activeSuggestion) {
                    activeSuggestion.classList.remove('active');
                    const prev = activeSuggestion.previousElementSibling || suggestions[suggestions.length - 1];
                    prev.classList.add('active');
                } else {
                    suggestions[suggestions.length - 1].classList.add('active');
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
    }

    // Check database connection and load tables
    async function checkConnection() {
        // Only show connection status and handles field on localhost
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            document.getElementById('connection-status').classList.add('localhost');
            document.querySelector('.form-field.participant-handles-field').classList.add('localhost');
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                if (data.database_connected) {
                    document.getElementById('connection-status').innerHTML = 
                        '<p style="color: green;"><i data-feather="check-circle" style="width: 16px; height: 16px;"></i> Database connected</p>';
                    loadTables();
                } else {
                    // Handle undefined or missing error message
                    const errorMessage = data.error || data.message || 'Connection unavailable';
                    const detailedError = getDetailedErrorMessage(errorMessage, data);
                    
                    document.getElementById('connection-status').innerHTML = 
                        `<p style="color: #856404; background: #fff3cd; padding: 8px 12px; border-radius: 4px; border: 1px solid #ffeaa7;">
                            <i data-feather="info" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                            <strong>Demo Mode</strong><br>
                            <span style="font-size: 0.9em; margin-left: 22px;">${detailedError}</span>
                        </p>`;
                }
                
                // Initialize feather icons after updating DOM
                // Feather icons handled by nav.js
            } catch (error) {
                handleApiConnectionError(error, 'connection-status');
            }
        }
    }
    
    // Load and display tables
    async function loadTables() {
        try {
            const response = await fetch(`${API_BASE}/tables`);
            const data = await response.json();
            
            let html = '<h2>Database Tables:</h2><ul>';
            for (const table of data.tables) {
                html += `<li>${table.name} (${table.row_count} rows)</li>`;
            }
            html += '</ul>';
            
            document.getElementById('tables-list').innerHTML = html;
        } catch (error) {
            handleApiConnectionError(error, 'tables-list');
        }
    }
    
    // Handle project form submission
    document.getElementById('project-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const project = {
            name: formData.get('name'),
            location: formData.get('location'),
            description: formData.get('description'),
            participant_names: formData.get('participant_names'),
            participant_handles: formData.get('participant_handles'),
            total_participants: parseInt(formData.get('total_participants')) || 1,
            status: formData.get('status'),
            estimated_start_date: formData.get('estimated_start_date') || null,
            estimated_end_date: formData.get('estimated_end_date') || null
        };
        
        try {
            let response, result;
            
            if (editingProjectId) {
                // Update existing project
                response = await fetch(`${API_BASE}/projects/${editingProjectId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(project)
                });
            } else {
                // Create new project
                response = await fetch(`${API_BASE}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(project)
                });
            }
            
            result = await response.json();
            
            if (response.ok) {
                const actionText = editingProjectId ? 'updated' : 'added';
                
                // Check if we're in visit mode for success message
                const urlParams = new URLSearchParams(window.location.search);
                const isVisitMode = urlParams.get('add') === 'visit';
                const itemType = isVisitMode ? 'Visit' : 'Project';
                
                document.getElementById('form-result').innerHTML = 
                    `<p style="color: green;"><i data-feather="check-circle" style="width: 16px; height: 16px;"></i> ${itemType} ${actionText} successfully!</p>`;
                // Feather icons handled by nav.js
                
                if (!editingProjectId) {
                    e.target.reset();
                }
                
                // Reset form state
                resetForm();
                
                // Refresh current view
                if (currentView === 'projects' && projectsLoaded) {
                    loadProjects(currentPage);
                }
                if (currentView === 'tables' && tablesLoaded) {
                    loadTables();
                }
                
                // Show projects list again if we were editing and current view is projects
                if (currentView === 'projects' && editingProjectId) {
                    document.getElementById('projects-view-section').classList.add('active');
                    setTimeout(() => {
                        document.querySelector('.projects-section h2').scrollIntoView({ behavior: 'smooth' });
                    }, 500);
                }
                
            } else {
                document.getElementById('form-result').innerHTML = 
                    `<p style="color: #856404; background: #fff3cd; padding: 8px 12px; border-radius: 4px; border: 1px solid #ffeaa7; margin-top: 10px;">
                        <i data-feather="info" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                        <strong>Demo Mode:</strong> Database connection inactive. <a href="../admin/server/" style="color: #856404; text-decoration: underline;">Configure Your Local Server</a>
                    </p>`;
                // Feather icons handled by nav.js
            }
        } catch (error) {
            document.getElementById('form-result').innerHTML = 
                `<p style="color: #856404; background: #fff3cd; padding: 8px 12px; border-radius: 4px; border: 1px solid #ffeaa7; margin-top: 10px;">
                    <i data-feather="info" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                    <strong>Demo Mode:</strong> Database connection inactive. <a href="../admin/server/" style="color: #856404; text-decoration: underline;">Configure Your Local Server</a>
                </p>`;
            // Feather icons handled by nav.js
        }
    });
    
    // Handle participant handles field - clean up email addresses
    document.querySelector('textarea[name="participant_handles"]').addEventListener('blur', function() {
        let value = this.value;
        if (value.trim()) {
            // Split by comma, clean each handle, and rejoin
            let handles = value.split(',').map(handle => {
                handle = handle.trim();
                // If handle contains @, remove @ and everything after it
                if (handle.includes('@')) {
                    handle = handle.split('@')[0];
                }
                return handle;
            }).filter(handle => handle.length > 0); // Remove empty handles
            
            this.value = handles.join(', ');
        }
    });
    
    // Select all content when clicking Total Participants field
    document.querySelector('input[name="total_participants"]').addEventListener('click', function() {
        this.select();
    });
    
    // Check URL parameters and update title if needed
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('add') === 'visit') {
        document.getElementById('page-title').textContent = 'Add City Visit';
        document.querySelector('h1').textContent = 'Add City Visit';
        document.querySelector('.add-visit-btn').textContent = 'Save Visit';
        document.getElementById('add-new-text').textContent = 'Add Visit';
        document.getElementById('projects-header').textContent = 'All Visits';
        document.getElementById('view-projects-text').textContent = 'View Visits';
        document.getElementById('projects-empty-state').textContent = 'Click "View Visits" above to load the visits list.';
    }
    
    // Projects list functionality
    let currentPage = 1;
    const projectsPerPage = 100;
    let totalProjects = 0;
    let editingProjectId = null;
    
    // Load projects list with pagination
    async function loadProjects(page = 1) {
        try {
            const offset = (page - 1) * projectsPerPage;
            const response = await fetch(`${API_BASE}/projects?limit=${projectsPerPage}&offset=${offset}`);
            const data = await response.json();
            
            if (response.ok) {
                // Handle different response formats from the API
                const projects = data.data || data.projects || [];
                displayProjects(projects);
                totalProjects = data.total || projects.length;
                displayPagination(page, totalProjects);
                currentPage = page;
            } else {
                document.getElementById('projects-container').innerHTML = 
                    '<div class="no-projects">Unable to load projects. Check database connection.</div>';
            }
        } catch (error) {
            document.getElementById('projects-container').innerHTML = 
                '<div class="no-projects">Demo Mode: Database connection inactive. Projects will appear here when connected.</div>';
        }
    }
    
    // Display projects list
    function displayProjects(projects) {
        const container = document.getElementById('projects-container');
        
        // Store projects data for editing
        projectsData = projects;
        
        if (projects.length === 0) {
            container.innerHTML = '<div class="no-projects">No projects found. Add your first project above!</div>';
            return;
        }
        
        const projectsHtml = projects.map(project => `
            <div class="project-item">
                <div class="project-title">${escapeHtml(project.name || 'Untitled Project')}</div>
                <div class="project-details">
                    ${project.description ? escapeHtml(project.description) : 'No description available'}
                </div>
                <div class="project-meta">
                    <div class="project-info">
                        ${project.location ? `<span><i data-feather="map-pin" style="width: 14px; height: 14px;"></i> ${escapeHtml(project.location)}</span>` : ''}
                        ${project.estimated_start_date ? `<span><i data-feather="calendar" style="width: 14px; height: 14px;"></i> Start: ${formatDate(project.estimated_start_date)}</span>` : ''}
                        ${project.estimated_end_date ? `<span><i data-feather="calendar" style="width: 14px; height: 14px;"></i> End: ${formatDate(project.estimated_end_date)}</span>` : ''}
                        ${project.total_participants ? `<span><i data-feather="users" style="width: 14px; height: 14px;"></i> ${project.total_participants} participants</span>` : ''}
                        ${project.created_date ? `<span><i data-feather="clock" style="width: 14px; height: 14px;"></i> ${formatDate(project.created_date)}</span>` : ''}
                        <span class="status-badge ${getStatusClass(project.status)}">
                            ${project.status || 'No Status'}
                        </span>
                    </div>
                    <button class="edit-btn" onclick="editProject('${project.id}')">
                        <i data-feather="edit" style="width: 14px; height: 14px;"></i> Edit
                    </button>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = `<div class="projects-list">${projectsHtml}</div>`;
        // Feather icons handled by nav.js
    }
    
    // Display pagination controls
    function displayPagination(currentPage, totalProjects) {
        const totalPages = Math.ceil(totalProjects / projectsPerPage);
        const container = document.getElementById('pagination-container');
        
        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }
        
        let paginationHtml = '<div class="pagination">';
        
        // Previous button
        if (currentPage > 1) {
            paginationHtml += `<a href="#" class="pagination-btn" onclick="loadProjects(${currentPage - 1}); return false;">Previous</a>`;
        } else {
            paginationHtml += '<span class="pagination-btn disabled">Previous</span>';
        }
        
        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        if (startPage > 1) {
            paginationHtml += `<a href="#" class="pagination-btn" onclick="loadProjects(1); return false;">1</a>`;
            if (startPage > 2) {
                paginationHtml += '<span class="pagination-btn disabled">...</span>';
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHtml += `<span class="pagination-btn active">${i}</span>`;
            } else {
                paginationHtml += `<a href="#" class="pagination-btn" onclick="loadProjects(${i}); return false;">${i}</a>`;
            }
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHtml += '<span class="pagination-btn disabled">...</span>';
            }
            paginationHtml += `<a href="#" class="pagination-btn" onclick="loadProjects(${totalPages}); return false;">${totalPages}</a>`;
        }
        
        // Next button
        if (currentPage < totalPages) {
            paginationHtml += `<a href="#" class="pagination-btn" onclick="loadProjects(${currentPage + 1}); return false;">Next</a>`;
        } else {
            paginationHtml += '<span class="pagination-btn disabled">Next</span>';
        }
        
        // Info
        const startItem = (currentPage - 1) * projectsPerPage + 1;
        const endItem = Math.min(currentPage * projectsPerPage, totalProjects);
        paginationHtml += `<div class="pagination-info">Showing ${startItem}-${endItem} of ${totalProjects} projects</div>`;
        
        paginationHtml += '</div>';
        container.innerHTML = paginationHtml;
    }
    
    // Store projects data for editing
    let projectsData = [];
    
    // Edit project functionality
    async function editProject(projectId) {
        editingProjectId = projectId;
        
        // Find project in current data
        const project = projectsData.find(p => p.id === projectId);
        
        if (project) {
            // Populate form fields with available data
            document.querySelector('input[name="name"]').value = project.name || '';
            document.querySelector('input[name="location"]').value = project.location || '';
            document.querySelector('textarea[name="description"]').value = project.description || '';
            document.querySelector('textarea[name="participant_names"]').value = project.participant_names || '';
            document.querySelector('textarea[name="participant_handles"]').value = project.participant_handles || '';
            document.querySelector('input[name="total_participants"]').value = project.total_participants || 1;
            document.querySelector('select[name="status"]').value = project.status || 'Active';
            document.querySelector('input[name="estimated_start_date"]').value = project.estimated_start_date || '';
            document.querySelector('input[name="estimated_end_date"]').value = project.estimated_end_date || '';
            
            // Update form title and button based on visit mode
            const urlParams = new URLSearchParams(window.location.search);
            const isVisitMode = urlParams.get('add') === 'visit';
            
            if (isVisitMode) {
                document.querySelector('h1').textContent = 'Edit City Visit';
                document.querySelector('.add-visit-btn').textContent = 'Update Visit';
            } else {
                document.querySelector('h1').textContent = 'Edit Project';
                document.querySelector('.add-visit-btn').textContent = 'Update Project';
            }
            
            // Hide the projects list and show form
            document.getElementById('projects-view-section').classList.remove('active');
            
            // Scroll to form
            scrollToForm();
            
            // Show success message
            document.getElementById('form-result').innerHTML = 
                '<p style="color: #0066cc;"><i data-feather="info" style="width: 16px; height: 16px;"></i> Project loaded for editing</p>';
            // Feather icons handled by nav.js
        } else {
            // Fallback - try to fetch individual project
            try {
                const response = await fetch(`${API_BASE}/projects/${projectId}`);
                const data = await response.json();
                
                if (response.ok && (data.project || data)) {
                    const projectData = data.project || data;
                    
                    // Populate form fields
                    document.querySelector('input[name="name"]').value = projectData.name || '';
                    document.querySelector('input[name="location"]').value = projectData.location || '';
                    document.querySelector('textarea[name="description"]').value = projectData.description || '';
                    document.querySelector('textarea[name="participant_names"]').value = projectData.participant_names || '';
                    document.querySelector('textarea[name="participant_handles"]').value = projectData.participant_handles || '';
                    document.querySelector('input[name="total_participants"]').value = projectData.total_participants || 1;
                    document.querySelector('select[name="status"]').value = projectData.status || 'Active';
                    document.querySelector('input[name="estimated_start_date"]').value = projectData.estimated_start_date || '';
                    document.querySelector('input[name="estimated_end_date"]').value = projectData.estimated_end_date || '';
                    
                    // Update form title and button based on visit mode
                    const urlParams = new URLSearchParams(window.location.search);
                    const isVisitMode = urlParams.get('add') === 'visit';
                    
                    if (isVisitMode) {
                        document.querySelector('h1').textContent = 'Edit City Visit';
                        document.querySelector('.add-visit-btn').textContent = 'Update Visit';
                    } else {
                        document.querySelector('h1').textContent = 'Edit Project';
                        document.querySelector('.add-visit-btn').textContent = 'Update Project';
                    }
                    
                    // Hide the projects list and show form
                    document.getElementById('projects-view-section').classList.remove('active');
                    
                    // Scroll to form
                    scrollToForm();
                    
                    // Show success message
                    document.getElementById('form-result').innerHTML = 
                        '<p style="color: #0066cc;"><i data-feather="info" style="width: 16px; height: 16px;"></i> Project loaded for editing</p>';
                    // Feather icons handled by nav.js
                } else {
                    alert('Unable to load project for editing');
                }
            } catch (error) {
                alert('Demo Mode: Edit functionality requires individual project API endpoint. You can still add new projects above.');
            }
        }
    }
    
    // Helper functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString();
    }
    
    function getStatusClass(status) {
        switch (status) {
            case 'Active':
            case 'Included':
            case 'Include on Map':
                return 'status-included';
            case 'In Review':
            case 'Inactive':
                return 'status-review';
            default:
                return 'status-review';
        }
    }
    
    function scrollToForm() {
        document.querySelector('h1').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function resetForm() {
        editingProjectId = null;
        
        // Check if we're in visit mode
        const urlParams = new URLSearchParams(window.location.search);
        const isVisitMode = urlParams.get('add') === 'visit';
        
        if (isVisitMode) {
            document.querySelector('h1').textContent = 'Add City Visit';
            document.querySelector('.add-visit-btn').textContent = 'Save Visit';
        } else {
            document.querySelector('h1').textContent = 'Project';
            document.querySelector('.add-visit-btn').textContent = 'Save Project';
        }
        
        document.getElementById('form-result').innerHTML = '';
    }
    
    // Add new project function - clears form and resets to add mode
    function addNewProject() {
        // Clear all form fields
        document.getElementById('project-form').reset();
        
        // Reset form state
        resetForm();
        
        // Hide all sections (projects and tables)
        document.getElementById('projects-view-section').classList.remove('active');
        document.getElementById('tables-section').classList.remove('active');
        
        // Update button states - make Add Project/Visit active, others inactive
        document.getElementById('add-new-btn').classList.add('active');
        document.getElementById('view-projects-btn').classList.remove('active');
        document.getElementById('view-tables-btn').classList.remove('active');
        
        // Update tables button text to default state
        document.getElementById('tables-btn-text').textContent = 'View Tables';
        
        // Clear current view
        currentView = null;
        
        // Scroll to form
        scrollToForm();
        
        // Check if we're in visit mode for message
        const urlParams = new URLSearchParams(window.location.search);
        const isVisitMode = urlParams.get('add') === 'visit';
        const itemType = isVisitMode ? 'visit' : 'project';
        
        // Show message
        document.getElementById('form-result').innerHTML = 
            `<p style="color: #0066cc;"><i data-feather="info" style="width: 16px; height: 16px;"></i> Ready to add a new ${itemType}</p>`;
        // Feather icons handled by nav.js
    }
    
    // Dark mode functionality
    function toggleDarkMode() {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        
        // Update toggle button icon and text
        const toggleIcon = document.getElementById('toggle-icon');
        const toggleText = document.getElementById('toggle-text');
        
        if (isDark) {
            toggleIcon.setAttribute('data-feather', 'toggle-right');
            toggleText.textContent = 'Light';
        } else {
            toggleIcon.setAttribute('data-feather', 'toggle-left');
            toggleText.textContent = 'Dark';
        }
        
        // Re-initialize feather icons to update the changed icon
        if (window.standaloneNav && window.standaloneNav.replaceFeatherIcons) {
            window.standaloneNav.replaceFeatherIcons();
        }
        
        // Save preference
        localStorage.setItem('darkMode', isDark);
    }
    
    // Load dark mode preference
    function loadDarkModePreference() {
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) {
            document.body.classList.add('dark');
            const toggleIcon = document.getElementById('toggle-icon');
            const toggleText = document.getElementById('toggle-text');
            toggleIcon.setAttribute('data-feather', 'toggle-right');
            toggleText.textContent = 'Light';
            // Re-initialize feather icons
            // Feather icons handled by nav.js
        }
    }
    
    // View state management
    let currentView = null;
    let tablesLoaded = false;
    let projectsLoaded = false;
    
    // Toggle view functions
    function showTablesView() {
        // Update button states
        document.getElementById('view-tables-btn').classList.add('active');
        document.getElementById('view-projects-btn').classList.remove('active');
        
        // Show tables section, hide projects section
        document.getElementById('tables-section').classList.add('active');
        document.getElementById('projects-view-section').classList.remove('active');
        
        // Load tables if not already loaded
        if (!tablesLoaded) {
            loadTables();
            tablesLoaded = true;
        }
        
        currentView = 'tables';
        
        // Update button text
        document.getElementById('tables-btn-text').textContent = 'Hide Tables';
    }
    
    function toggleTablesView() {
        const tablesSection = document.getElementById('tables-section');
        const tablesBtn = document.getElementById('view-tables-btn');
        const tablesBtnText = document.getElementById('tables-btn-text');
        const isCurrentlyVisible = tablesSection.classList.contains('active');
        
        if (isCurrentlyVisible) {
            // Hide tables
            tablesSection.classList.remove('active');
            tablesBtn.classList.remove('active');
            tablesBtnText.textContent = 'View Tables';
            
            // If we were in tables view, clear current view
            if (currentView === 'tables') {
                currentView = null;
            }
        } else {
            // Show tables
            tablesSection.classList.add('active');
            tablesBtn.classList.add('active');
            tablesBtnText.textContent = 'Hide Tables';
            
            // Don't hide other sections - allow tables to be shown alongside them
            
            // Load tables if not already loaded
            if (!tablesLoaded) {
                loadTables();
                tablesLoaded = true;
            }
            
            currentView = 'tables';
        }
    }
    
    function showProjectsView() {
        // Update button states - make View Projects active, others inactive
        document.getElementById('view-projects-btn').classList.add('active');
        document.getElementById('view-tables-btn').classList.remove('active');
        document.getElementById('add-new-btn').classList.remove('active');
        
        // Show projects section, hide tables section
        document.getElementById('projects-view-section').classList.add('active');
        document.getElementById('tables-section').classList.remove('active');
        
        // Reset tables button text
        document.getElementById('tables-btn-text').textContent = 'View Tables';
        
        // Load projects if not already loaded
        if (!projectsLoaded) {
            loadProjects();
            projectsLoaded = true;
        }
        
        currentView = 'projects';
    }
    
    // Initialize
    checkConnection();
    loadDarkModePreference();
    loadCSVData();
    setupNameLookup();

    // Location autocomplete functionality
    let citiesData = [];
    let locationSearchTimeout;

    // Load cities data from CSV
    async function loadCitiesData() {
        try {
            console.log('DEBUG: Starting to load cities data from map/cities.csv');
            const response = await fetch('map/cities.csv');
            console.log('DEBUG: Response status:', response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const csvText = await response.text();
            
            console.log('DEBUG: Raw CSV text length:', csvText.length);
            console.log('DEBUG: First 200 chars:', csvText.substring(0, 200));
            
            // Parse CSV data
            const lines = csvText.split('\n').filter(line => line.trim().length > 0);
            console.log('DEBUG: Total lines found:', lines.length);
            
            if (lines.length < 2) {
                throw new Error('CSV file appears to be empty or invalid');
            }
            
            const headers = lines[0].split(',').map(h => h.trim());
            console.log('DEBUG: Headers found:', headers);
            
            citiesData = lines.slice(1).map((line, lineIndex) => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, colIndex) => {
                    obj[header] = values[colIndex] ? values[colIndex].trim() : '';
                });
                
                // Debug first few rows
                if (lineIndex < 3) {
                    console.log(`DEBUG: Row ${lineIndex + 1}:`, obj);
                }
                
                return obj;
            }).filter(obj => obj.City && obj.City.length > 0);
            
            console.log('Cities data loaded:', citiesData.length, 'cities');
        } catch (error) {
            console.error('Failed to load cities data:', error);
        }
    }

    // Search cities by name
    function searchCities(query) {
        if (!query || query.length < 2) return [];
        
        const searchTerm = query.toLowerCase();
        return citiesData.filter(city => 
            city.City && city.City.toLowerCase().includes(searchTerm)
        ).slice(0, 10); // Limit to 10 suggestions
    }

    // Show location suggestions
    function showLocationSuggestions(suggestions, inputElement) {
        let suggestionsDiv = document.getElementById('location-suggestions');
        
        if (suggestions.length === 0) {
            if (suggestionsDiv) {
                suggestionsDiv.style.display = 'none';
            }
            return;
        }
        
        // Create suggestions div if it doesn't exist or move it to body
        if (!suggestionsDiv || suggestionsDiv.parentElement !== document.body) {
            // Remove existing one if it's in the wrong place
            if (suggestionsDiv) {
                suggestionsDiv.remove();
            }
            
            suggestionsDiv = document.createElement('div');
            suggestionsDiv.id = 'location-suggestions';
            suggestionsDiv.className = 'location-suggestions';
            document.body.appendChild(suggestionsDiv);
        }
        
        const suggestionsHtml = suggestions.map(city => {
            return `<div class="location-suggestion" data-city="${city.City}">${city.City}</div>`;
        }).join('');
        
        suggestionsDiv.innerHTML = suggestionsHtml;
        
        // Position the dropdown relative to the input field
        positionLocationDropdown(suggestionsDiv, inputElement);
        suggestionsDiv.style.display = 'block';
        
        // Add click handlers
        suggestionsDiv.querySelectorAll('.location-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', function() {
                selectLocation(this.dataset.city, inputElement);
            });
        });
    }

    // Select a location and update both Location and Description fields
    function selectLocation(cityName, inputElement) {
        const locationField = inputElement;
        const descriptionField = document.querySelector('textarea[name="description"]');
        
        // Find the position where we're inserting
        const cursorPos = inputElement.selectionStart;
        const textBeforeCursor = inputElement.value.substring(0, cursorPos);
        const textAfterCursor = inputElement.value.substring(cursorPos);
        
        // Find the last comma before cursor to replace the partial query
        const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
        const beforeQuery = lastCommaIndex === -1 ? '' : textBeforeCursor.substring(0, lastCommaIndex + 1) + ' ';
        
        // Update location field
        const newLocationValue = beforeQuery + cityName + textAfterCursor;
        locationField.value = newLocationValue;
        
        // Update description field
        updateDescriptionFromLocation(newLocationValue);
        
        // Hide suggestions
        hideLocationSuggestions();
        
        // Position cursor after the inserted city name
        const newCursorPos = (beforeQuery + cityName).length;
        setTimeout(() => {
            locationField.setSelectionRange(newCursorPos, newCursorPos);
            locationField.focus();
            
            // If there's no text after and we're not at the end, add a comma and space for next entry
            if (!textAfterCursor.trim() && newCursorPos === locationField.value.length) {
                const shouldAddComma = !locationField.value.endsWith(',') && !locationField.value.endsWith(', ');
                if (shouldAddComma) {
                    locationField.value += ', ';
                    locationField.setSelectionRange(locationField.value.length, locationField.value.length);
                }
            }
        }, 0);
    }

    // Update description field based on location
    function updateDescriptionFromLocation(locationValue) {
        const descriptionField = document.querySelector('textarea[name="description"]');
        const statusElement = document.querySelector('.location-status');
        
        if (!locationValue.trim()) {
            statusElement.style.display = 'none';
            return;
        }
        
        // Get cities from location field
        const currentCities = locationValue.split(',').map(c => c.trim()).filter(c => c);
        
        if (currentCities.length === 0) {
            statusElement.style.display = 'none';
            return;
        }
        
        // Check if current description matches the "Visited [cities]" pattern
        const currentDescription = descriptionField.value.trim();
        const expectedDescription = `Visited ${currentCities.join(', ')}`;
        
        // Extract cities from current description if it follows the pattern
        const visitedMatch = currentDescription.match(/^Visited\s+(.+)$/);
        
        if (visitedMatch) {
            const descriptionCities = visitedMatch[1].split(',').map(c => c.trim()).filter(c => c);
            
            // Check if description cities match location cities
            const citiesMatch = descriptionCities.length === currentCities.length && 
                               descriptionCities.every(city => currentCities.includes(city)) &&
                               currentCities.every(city => descriptionCities.includes(city));
            
            if (citiesMatch) {
                // Cities match, update description
                descriptionField.value = expectedDescription;
                statusElement.style.display = 'none';
            } else {
                // Cities don't match, show warning
                const mismatchedCities = [
                    ...descriptionCities.filter(city => !currentCities.includes(city)),
                    ...currentCities.filter(city => !descriptionCities.includes(city))
                ];
                statusElement.textContent = `Didn't update Description since cities don't match: ${mismatchedCities.join(', ')}`;
                statusElement.style.display = 'block';
            }
        } else if (!currentDescription || currentDescription === expectedDescription) {
            // No description or exact match, update it
            descriptionField.value = expectedDescription;
            statusElement.style.display = 'none';
        } else {
            // Description exists but doesn't follow pattern, show warning
            statusElement.textContent = `Didn't update Description since it doesn't follow "Visited [cities]" pattern`;
            statusElement.style.display = 'block';
        }
    }

    // Position dropdown for location suggestions
    function positionLocationDropdown(suggestionsDiv, inputElement) {
        const rect = inputElement.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        
        suggestionsDiv.style.position = 'absolute';
        suggestionsDiv.style.top = (rect.bottom + scrollTop + 2) + 'px';
        suggestionsDiv.style.left = (rect.left + scrollLeft) + 'px';
        suggestionsDiv.style.width = rect.width + 'px';
    }

    // Hide location suggestions helper function
    function hideLocationSuggestions() {
        const suggestionsDiv = document.getElementById('location-suggestions');
        if (suggestionsDiv) {
            suggestionsDiv.style.display = 'none';
        }
    }

    // Setup location lookup
    function setupLocationLookup() {
        const locationField = document.querySelector('input[name="location"]');
        
        if (!locationField) return;
        
        locationField.addEventListener('input', function() {
            clearTimeout(locationSearchTimeout);
            
            locationSearchTimeout = setTimeout(() => {
                const cursorPos = this.selectionStart;
                const textBeforeCursor = this.value.substring(0, cursorPos);
                const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
                const currentQuery = textBeforeCursor.substring(lastCommaIndex + 1).trim();
                
                if (currentQuery.length >= 2) {
                    const suggestions = searchCities(currentQuery);
                    showLocationSuggestions(suggestions, this);
                } else {
                    hideLocationSuggestions();
                }
            }, 300);
        });
        
        // Update description when location field changes
        locationField.addEventListener('blur', function() {
            updateDescriptionFromLocation(this.value);
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.location-lookup-container') && !e.target.closest('.location-suggestions')) {
                hideLocationSuggestions();
            }
        });
        
        // Update dropdown position on scroll and resize
        window.addEventListener('scroll', function() {
            const suggestionsDiv = document.getElementById('location-suggestions');
            if (suggestionsDiv && suggestionsDiv.style.display === 'block') {
                // Check if input field is still visible
                const inputRect = locationField.getBoundingClientRect();
                if (inputRect.bottom < 0 || inputRect.top > window.innerHeight) {
                    suggestionsDiv.style.display = 'none';
                } else {
                    positionLocationDropdown(suggestionsDiv, locationField);
                }
            }
        }, { passive: true });
        
        window.addEventListener('resize', function() {
            const suggestionsDiv = document.getElementById('location-suggestions');
            if (suggestionsDiv && suggestionsDiv.style.display === 'block') {
                positionLocationDropdown(suggestionsDiv, locationField);
            }
        });
    }

    // Initialize location autocomplete
    loadCitiesData().then(() => {
        setupLocationLookup();
    });

    // Hide Handles field for model.georgia
    function checkHandlesVisibility() {
        const modelsiteCookie = typeof Cookies !== 'undefined' ? Cookies.get('modelsite') : null;
        const handlesField = document.querySelector('.form-field.participant-handles-field');
        
        if (modelsiteCookie === 'model.georgia' && handlesField) {
            handlesField.style.display = 'none';
            console.log('DEBUG: Hiding Handles field for model.georgia');
        } else if (handlesField) {
            handlesField.style.display = '';
            console.log('DEBUG: Showing Handles field for modelsite:', modelsiteCookie);
        }
    }

    // Check handles visibility on page load
    checkHandlesVisibility();
    
    // Feather icons handled by nav.js
</script>
</body>
</html>