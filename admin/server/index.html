<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../img/logo/neighborhood/favicon.png">
    <title>Configure Your Local Server</title>

    <link type="text/css" rel="stylesheet" href="../../../localsite/css/base.css" id="/localsite/css/base.css" />
    <script type="text/javascript" src="../../../localsite/js/localsite.js?showheader=true"></script>

    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/shared-styles.css">
    <script src="../../js/setup.js"></script>
    
    <!-- Side Nav -->
    <link rel="stylesheet" href="../../../localsite/css/nav.css">
    <script src="../../../localsite/js/nav.js"></script>
    <style>
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="breadcrumb">
            <a href="../">← Admin Dashboard</a>
        </div>

        <div class="header">
            <h1>
                <div class="gemini-icon">C</div>
                Configure Your Local Server
                <!-- Google Gemini Insights -->
            </h1>
            <p><a href="../../projects/#list=all">Our Data Insights Page</a> let's you send a dataset to Claude and Gemini for analysis when <a href="../">running the site locally</a>.</p>
        </div>

        <div class="card" id="textInPage">
          <div id="gitAccountFieldsContainer"></div>
          <div id="webrootSetup"></div>
        </div>

        <div id="os-detection-container"></div>

        <div class="card" id="web-server-panel">
            <h2 class="card-title">
                <span class="status-indicator" id="web-server-status"></span>
                <span id="web-server-title">Local Web Server</span>
            </h2>
            <div id="web-server-content">
                <p style="color: var(--text-secondary);">
                    Checking web server status...
                </p>
            </div>
        </div>

        <div id="combined-rust-api-container"></div>

        <div class="card" id="api-configuration-panel">
            <h2 class="card-title">
                <span class="status-indicator" id="api-status"></span>
                API Configuration Status
            </h2>
            
            <div id="gemini-key-container" style="display: none;"></div>
            

            <div id="test-instruction" style="margin-bottom: 10px;">
                Start the Rust API first. Then you can test the Gemini API.
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="test-gemini" disabled>
                    <span class="loading-spinner" id="test-spinner" style="display: none;"></span>
                    Test Gemini API
                </button>
            </div>

            <div id="test-result"></div>
            
            <div class="actions" style="margin-top: 16px;">
                <button class="btn btn-primary" id="analyze-data" style="display: none;" onclick="window.location.href='../import-data.html#m=gemini'">
                    Analyze Data using Gemini
                </button>
            </div>
        </div>


        <div class="card">
            <h2 class="card-title">About Gemini AI Integration</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                Include Gemini AI insights for data analysis, content generation, 
                and smart recommendations for CRM activities.
            </p>
            
            <div class="info-grid">
                <div class="info-item">
                    <strong>API Key Requirements:</strong><br>
                    Valid Google Cloud project with Gemini API enabled
                </div>
                <div class="info-item">
                    <strong>Environment Variable:</strong><br>
                    GEMINI_API_KEY in your .env file
                </div>
                <div class="info-item">
                    <strong>API Endpoint:</strong><br>
                    generativelanguage.googleapis.com
                </div>
                <div class="info-item">
                    <strong>Test Method:</strong><br>
                    Lists available Gemini models
                </div>
            </div>

            <div class="warning-message">
                <strong>Security Note:</strong> Your API key is never displayed in full. Only the first 4 and last 4 characters are shown for verification.
            </div>
        </div>


        <div id="readmeDiv" class="card readme-content">
            <p style="color: var(--text-secondary); font-style: italic;">
                Loading README.md documentation...
            </p>
        </div>
    </div>

    <script src="../../js/common.js"></script>
    <script>
        const GEMINI_API_BASE = 'http://localhost:8081/api';
        let currentConfig = null;

        // DOM elements
        const apiStatus = document.getElementById('api-status');
        // configDisplay is now created dynamically, so we'll find it when needed
        const testButton = document.getElementById('test-gemini');
        const testSpinner = document.getElementById('test-spinner');
        const testResult = document.getElementById('test-result');
        const testInstruction = document.getElementById('test-instruction');
        const configTitle = document.querySelector('#api-configuration-panel .card-title');
        const geminiKeyContainer = document.getElementById('gemini-key-container');
        
        
        // Web Server panel elements
        const webServerPanel = document.getElementById('web-server-panel');
        const webServerStatus = document.getElementById('web-server-status');
        const webServerTitle = document.getElementById('web-server-title');
        const webServerContent = document.getElementById('web-server-content');

        // Update Web Server panel status
        function updateWebServerPanel() {
            const currentHost = window.location.hostname;
            const currentPort = window.location.port;
            const isLocalhost8887 = currentHost === 'localhost' && currentPort === '8887';
            
            if (isLocalhost8887) {
                webServerStatus.className = 'status-indicator connected';
                webServerTitle.textContent = 'Web Server Running';
                const currentUrl = window.location; // window.location.origin
                webServerContent.innerHTML = `
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Your local http server is <a href="${currentUrl}" style="color: var(--accent-blue); text-decoration: underline;">${currentUrl}</a>
                    </p>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="showWebserverCommand()">
                            Webserver Command
                        </button>
                    </div>
                `;
            } else {
                webServerStatus.className = 'status-indicator loading'; // grey dot for non-localhost
                webServerTitle.textContent = 'Local Web Server';
                webServerContent.innerHTML = `
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        To contribute code, view at <a href="https://localhost:8887/team/admin/server">localhost:8887/team/admin/server</a>. 
                        If your localhost server is not started, click to copy commands:
                    </p>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="showWebserverCommand()">
                            Start my local server
                        </button>
                    </div>
                `;
            }
        }

        // Show webserver command instructions
        function showWebserverCommand() {
            webServerContent.innerHTML = `
                <div id="webserver-command-content">
                    <p style="color: var(--text-secondary); margin-bottom: 16px;">
                        Webserver setup instructions and commands:
                    </p>
                    <div id="claude-webserver-status"></div>
                    <button class="btn btn-secondary" onclick="updateWebServerPanel()" style="margin-top: 16px;">
                        ← Back to Status
                    </button>
                </div>
            `;
            
            // Load webserver status content
            setTimeout(() => {
                loadWebServerStatus("claude-webserver-status");
            }, 100);
        }


        // Parse .env file content
        function parseEnvFile(envText) {
            const config = {};
            const lines = envText.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed && !trimmed.startsWith('#')) {
                    const [key, ...valueParts] = trimmed.split('=');
                    if (key && valueParts.length > 0) {
                        const value = valueParts.join('=');
                        config[key.trim()] = value.trim();
                    }
                }
            }
            
            // Apply same validation logic as backend
            config.gemini_api_key_present = !!(config.GEMINI_API_KEY && 
                config.GEMINI_API_KEY !== 'dummy_key' && 
                config.GEMINI_API_KEY !== 'get-key-at-aistudio.google.com');
                
            return config;
        }



        // Load README content for setup instructions
        function loadWebServerStatus(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Always show README content for local setup (web server status is now in its own panel)
            const readmeId = `${containerId}-readme`;
            container.innerHTML = `
                <h3 style="margin-bottom: 16px; color: var(--text-primary);">🛡️ Run Webserver Locally</h3>
                <div id="${readmeId}" class="readme-content">
                    <p style="color: var(--text-secondary); font-style: italic;">
                        Loading README.md...
                    </p>
                </div>
            `;
            
            // Load README content
            setTimeout(() => {
                displayFile("../README.md", readmeId, "_parent", null, false);
            }, 50);
        }

        // Show connection help (now displayed as a separate card below)
        function showConnectionHelp() {
            // Connection troubleshooting is now shown as a separate card on the page
            // No longer need to add inline help since it's always visible
        }

        // Create .env file from .env.example
        async function createEnvFromExample() {
            try {
                // First, try to read .env.example
                const exampleResponse = await fetch('../../.env.example');
                if (!exampleResponse.ok) {
                    throw new Error('.env.example file not found');
                }
                
                const exampleContent = await exampleResponse.text();
                
                // Try to create .env file via backend
                const createResponse = await fetch(`${GEMINI_API_BASE}/config/create-env`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: exampleContent
                    })
                });
                
                if (createResponse.ok) {
                    // Successfully created .env file
                    const configDisplay = document.getElementById('config-display');
                    if (configDisplay) configDisplay.innerHTML = `
                        <div style="color: var(--accent-green); margin-bottom: 16px;">
                            ✅ Created .env file from .env.example template
                        </div>
                        <strong>Configuration Source:</strong> .env file (newly created)<br>
                        <strong>Gemini API Key:</strong> <span style="color: var(--accent-red);">Needs to be configured</span><br>
                    `;
                    
                    // Show the Gemini key input field
                    geminiKeyContainer.style.display = 'block';
                    geminiKeyContainer.innerHTML = `
<div style="margin: 16px 0; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-light);">
    <strong>Enter Your Gemini API Key:</strong>
    <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
        <input type="text" id="gemini-key-input" placeholder="AIzaSy..." 
               style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-family: monospace;">
        <button id="save-key-btn" class="btn btn-primary" onclick="saveGeminiKey()">Save</button>
    </div>
    <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
        Get your API key from <a href="https://aistudio.google.com" target="_blank" style="color: var(--accent-blue);">Google AI Studio</a>
    </div>
</div>`;
                    
                    // Add enter key listener
                    setTimeout(() => {
                        const keyInput = document.getElementById('gemini-key-input');
                        if (keyInput) {
                            keyInput.addEventListener('keypress', function(e) {
                                if (e.key === 'Enter') {
                                    saveGeminiKey();
                                }
                            });
                        }
                    }, 100);
                    
                } else {
                    throw new Error('Failed to create .env file via backend');
                }
                
            } catch (error) {
                // Failed to create .env file
                configDisplay.innerHTML = `
                    <div style="color: var(--accent-red); margin-bottom: 16px;">
                        ❌ Could not create .env file automatically
                    </div>
                    <strong>Issue:</strong> ${error.message}<br><br>
                    <strong>Manual Setup Required:</strong><br>
                    1. Copy .env.example to .env<br>
                    2. Edit the GEMINI_API_KEY value<br>
                    3. Start the backend server<br>
                    Or run locally using the commands on our <a href="../admin" style="color: var(--accent-blue); text-decoration: underline;">Admin Page</a>
                `;
                
                // Show connection help for troubleshooting
                showConnectionHelp();
                
                console.error('Failed to create .env from example:', error);
            }
        }

        // Load configuration on page load
        async function loadConfiguration() {
            // Declare variables at function scope so they're available in catch block
            let envFileData = {};
            let envFileExists = false;
            
            try {
                apiStatus.className = 'status-indicator loading';
                const configDisplay = document.getElementById('config-display');
                if (configDisplay) configDisplay.textContent = 'Loading configuration files (.env and settings.js)...';
                
                // Load .env file directly from frontend first
                try {
                    const envFileResponse = await fetch('../../.env');
                    if (envFileResponse.ok) {
                        envFileExists = true;
                        const envFileText = await envFileResponse.text();
                        envFileData = parseEnvFile(envFileText);
                        console.log('Loaded .env file directly');
                    } else if (envFileResponse.status === 404) {
                        console.log('.env file not found');
                        envFileExists = false;
                    }
                } catch (envFileError) {
                    console.log('.env file loading failed:', envFileError.message);
                    envFileExists = false;
                }
                
                // Try to load .env configuration from backend
                let envData = {};
                try {
                    const envResponse = await fetch(`${GEMINI_API_BASE}/config/env`);
                    if (envResponse.ok) {
                        envData = await envResponse.json();
                    } else {
                        throw new Error(`Backend returned ${envResponse.status}`);
                    }
                } catch (backendError) {
                    console.log('Backend API unavailable:', backendError.message);
                    // Continue with .env file data only
                    throw new Error('Backend API unavailable');
                }
                
                // Load settings.js configuration from frontend (if available)
                let settingsData = {};
                try {
                    // Try to load config/settings.js if it exists as a simple JSON file
                    const settingsResponse = await fetch('../../config/settings.js');
                    if (settingsResponse.ok) {
                        settingsData = await settingsResponse.json();
                        console.log('Loaded settings.js configuration');
                    } else {
                        console.log('settings.js not found (this is optional)');
                    }
                } catch (settingsError) {
                    console.log('settings.js loading failed or not available (this is optional):', settingsError.message);
                }
                
                // Merge configurations (direct .env file takes highest precedence)
                const mergedConfig = {
                    ...settingsData,
                    ...envData,
                    ...envFileData,
                    source: 'merged (.env file + backend + settings.js)'
                };
                
                // Use .env file data for Gemini key presence if available
                if (envFileData.GEMINI_API_KEY !== undefined) {
                    mergedConfig.gemini_api_key_present = envFileData.gemini_api_key_present;
                }
                
                currentConfig = mergedConfig;
                displayConfiguration(mergedConfig);
                
                
                // Update title based on configuration status
                const hasIssues = !mergedConfig.gemini_api_key_present || !mergedConfig.database;
                const statusClass = hasIssues ? 'error' : 'connected';
                const titleText = !mergedConfig.gemini_api_key_present ? 'Gemini API Key Needed' : 
                                 hasIssues ? 'API Configuration Issue' : 'API Configuration Good';
                configTitle.innerHTML = `
                    <span class="status-indicator ${statusClass}" id="api-status"></span>
                    ${titleText}
                `;
                
                // Reset UI state when reloading configuration
                testButton.style.display = 'inline-block';
                testButton.className = 'btn btn-primary';
                testButton.textContent = 'Test Gemini API';
                testButton.disabled = !mergedConfig.gemini_api_key_present;
                document.getElementById('analyze-data').style.display = 'none';
                
                // Hide instruction when backend is available
                testInstruction.style.display = 'none';
                
                // Clear previous test results
                testResult.innerHTML = '';
                
                // Restart server functionality is now handled in the Rust API panel
                
            } catch (error) {
                
                // Even if backend is down, we can still use .env file data if available
                if (envFileExists && envFileData.GEMINI_API_KEY) {
                    // We have .env file data, use it for configuration
                    const hasValidKey = envFileData.gemini_api_key_present;
                    const statusClass = hasValidKey ? 'connected' : 'error';
                    const titleText = hasValidKey ? 'Gemini API Key Present' : 'Gemini API Key Needed';
                    
                    apiStatus.className = `status-indicator ${statusClass}`;
                    configTitle.innerHTML = `
                        <span class="status-indicator ${statusClass}" id="api-status"></span>
                        ${titleText}
                    `;
                    
                    // Show limited configuration from .env file
                    displayConfiguration({
                        ...envFileData,
                        source: '.env file (backend unavailable)',
                        database: null // We don't have database info without backend
                    });
                    
                    // Show instruction when backend is unavailable
                    testInstruction.style.display = 'block';
                    
                    // Backend status is now handled by the rust-api-panel
                    
                    // Show connection help for troubleshooting
                    showConnectionHelp();
                    
                } else if (envFileExists) {
                    // .env file exists but no valid key
                    apiStatus.className = 'status-indicator error';
                    configTitle.innerHTML = `
                        <span class="status-indicator error" id="api-status"></span>
                        Gemini API Key Needed
                    `;
                    
                    const configDisplay = document.getElementById('config-display');
                    if (configDisplay) configDisplay.innerHTML = `
                        <strong>Configuration Source:</strong> .env file (backend unavailable)<br>
                        <strong>Gemini API Key:</strong> <span style="color: var(--accent-red);">Not configured or invalid</span><br>
                    `;
                    
                    // Show instruction when backend is unavailable
                    testInstruction.style.display = 'block';
                    
                    // Show connection help for troubleshooting
                    showConnectionHelp();
                    
                } else {
                    // No .env file found - try to create it from .env.example
                    apiStatus.className = 'status-indicator error';
                    configTitle.innerHTML = `
                        <span class="status-indicator error" id="api-status"></span>
                        Gemini API Key Needed
                    `;
                    
                    // Show instruction when backend is unavailable
                    testInstruction.style.display = 'block';
                    
                    // Try to create .env from .env.example
                    await createEnvFromExample();
                }
                
                console.error('Failed to load configuration:', error);
            }
        }

        // Display configuration information
        function displayConfiguration(config) {
            const status = config.gemini_api_key_present ? 'Present' : 'Not configured';
            const statusColor = config.gemini_api_key_present ? 'var(--accent-green)' : 'var(--accent-red)';
            
            apiStatus.className = `status-indicator ${config.gemini_api_key_present ? 'connected' : 'error'}`;
            
            const configSource = config.source || '.env file';
            
            // Show/hide API key input field based on key presence
            if (!config.gemini_api_key_present) {
                geminiKeyContainer.style.display = 'block';
                geminiKeyContainer.innerHTML = `
<div style="margin: 16px 0; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-light);">
    <strong>Enter Your Gemini API Key:</strong>
    <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
        <input type="text" id="gemini-key-input" placeholder="AIzaSy..." 
               style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-family: monospace;">
        <button id="save-key-btn" class="btn btn-primary" onclick="saveGeminiKey()">Save</button>
    </div>
    <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
        Get your API key from <a href="https://aistudio.google.com" target="_blank" style="color: var(--accent-blue);">Google AI Studio</a>
    </div>
</div>`;
                
                // Add enter key listener to input field
                setTimeout(() => {
                    const keyInput = document.getElementById('gemini-key-input');
                    if (keyInput) {
                        keyInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                saveGeminiKey();
                            }
                        });
                    }
                }, 100);
            } else {
                // Show "Change" button when API key is present
                geminiKeyContainer.style.display = 'block';
                geminiKeyContainer.innerHTML = `
<div style="margin: 16px 0; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); border: 1px solid var(--border-light);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
        <strong>Gemini API Key:</strong>
        <button id="change-key-btn" class="btn btn-secondary" onclick="showChangeKeyForm()" style="font-size: 12px; padding: 4px 12px;">Change</button>
    </div>
    <div style="font-size: 12px; color: var(--text-secondary);">
        API key is configured and ready to use
    </div>
    <div id="change-key-form" style="display: none; margin-top: 12px; border-top: 1px solid var(--border-light); padding-top: 12px;">
        <strong>Enter New Gemini API Key:</strong>
        <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
            <input type="text" id="gemini-key-input-change" placeholder="AIzaSy..." 
                   style="flex: 1; padding: 8px 12px; border: 1px solid var(--border-medium); border-radius: var(--radius-sm); font-family: monospace;">
            <button id="save-new-key-btn" class="btn btn-primary" onclick="saveGeminiKey(true)">Save</button>
            <button id="cancel-change-btn" class="btn btn-secondary" onclick="hideChangeKeyForm()">Cancel</button>
        </div>
        <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
            Get your API key from <a href="https://aistudio.google.com" target="_blank" style="color: var(--accent-blue);">Google AI Studio</a>
        </div>
    </div>
</div>`;
            }

            // Display regular configuration info
            const keyDisplay = config.gemini_api_key_present ? 
                `<span style="color: ${statusColor};">Configured and ready</span>` : 
                `<span style="color: ${statusColor};">${status}</span>`;
                
            configDisplay.innerHTML = `
<strong>Configuration Source:</strong> ${configSource}
<strong>Gemini API Key:</strong> ${keyDisplay}
<strong>Database:</strong> ${config.database ? config.database.database + ' @ ' + config.database.server : 'Not configured'}
<strong>SSL:</strong> ${config.database ? (config.database.ssl ? 'Enabled' : 'Disabled') : 'N/A'}
<strong>Environment:</strong> ${config.gemini_api_key_present ? 'Production' : 'Development'}`;
        }

        // Save Gemini API key
        async function saveGeminiKey(isChange = false) {
            const keyInputId = isChange ? 'gemini-key-input-change' : 'gemini-key-input';
            const saveBtnId = isChange ? 'save-new-key-btn' : 'save-key-btn';
            
            const keyInput = document.getElementById(keyInputId);
            const saveBtn = document.getElementById(saveBtnId);
            
            if (!keyInput || !keyInput.value.trim()) {
                alert('Please enter a valid API key');
                return;
            }
            
            const apiKey = keyInput.value.trim();
            
            // Basic validation - Gemini keys should start with AIza and be around 39 chars
            if (!apiKey.startsWith('AIza') || apiKey.length < 35) {
                alert('API key format appears invalid. Gemini keys should start with "AIza" and be around 39 characters long.');
                return;
            }
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
                
                // Check if .env file exists
                let envExists = false;
                try {
                    const envCheck = await fetch('../../.env');
                    envExists = envCheck.ok;
                } catch (e) {
                    envExists = false;
                }
                
                if (!envExists) {
                    // Create .env from .env.example first
                    try {
                        const exampleResponse = await fetch('../../.env.example');
                        if (!exampleResponse.ok) {
                            throw new Error('.env.example file not found');
                        }
                        
                        const exampleContent = await exampleResponse.text();
                        
                        // Replace the placeholder Gemini key with the real one
                        const updatedContent = exampleContent.replace(
                            /GEMINI_API_KEY=.*/,
                            `GEMINI_API_KEY=${apiKey}`
                        );
                        
                        // Create .env file with the updated content
                        const createResponse = await fetch(`${GEMINI_API_BASE}/config/create-env`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                content: updatedContent
                            })
                        });
                        
                        if (!createResponse.ok) {
                            throw new Error('Failed to create .env file');
                        }
                        
                        // Hide the input field and show success message
                        geminiKeyContainer.style.display = 'none';
                        
                        // Update the configuration display
                        const configDisplay = document.getElementById('config-display');
                    if (configDisplay) configDisplay.innerHTML = `
                            <div style="color: var(--accent-green); margin-bottom: 16px; font-weight: bold;">
                                ✅ Successfully created .env file from template and added your Gemini API key!
                            </div>
                            <strong>Configuration Source:</strong> .env file (newly created)<br>
                            <strong>Gemini API Key:</strong> <span style="color: var(--accent-green);">Configured and ready</span><br>
                            <strong>Status:</strong> <span style="color: var(--accent-green);">Configuration complete</span>
                        `;
                        
                        // Update the title to show success
                        configTitle.innerHTML = `
                            <span class="status-indicator connected" id="api-status"></span>
                            API Configuration Good
                        `;
                        
                        return; // Exit early since we've handled everything
                        
                    } catch (error) {
                        alert('Failed to create .env file: ' + error.message);
                        return;
                    }
                } else {
                    // .env file exists, just update the key
                    const response = await fetch(`${GEMINI_API_BASE}/config/env`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            GEMINI_API_KEY: apiKey
                        })
                    });
                    
                    if (response.ok) {
                        // Hide the change form if this was a change operation
                        if (isChange) {
                            hideChangeKeyForm();
                        }
                        
                        // Reload configuration to update the display
                        await loadConfiguration();
                        
                        // Show success message
                        const configDisplayUpdate = document.getElementById('config-display');
                        if (configDisplayUpdate) configDisplayUpdate.innerHTML += `
                            <br><div style="color: var(--accent-green); margin-top: 16px; font-weight: bold;">
                                ✅ Gemini API key ${isChange ? 'changed' : 'updated'} successfully!
                            </div>
                        `;
                    } else {
                        const error = await response.json();
                        alert('Failed to save API key: ' + (error.error || 'Unknown error'));
                    }
                }
                
            } catch (error) {
                alert('Error saving API key: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            }
        }

        // Show the change API key form
        function showChangeKeyForm() {
            const changeForm = document.getElementById('change-key-form');
            const changeBtn = document.getElementById('change-key-btn');
            
            if (changeForm && changeBtn) {
                changeForm.style.display = 'block';
                changeBtn.style.display = 'none';
                
                // Focus on the input field and add enter key listener
                setTimeout(() => {
                    const keyInput = document.getElementById('gemini-key-input-change');
                    if (keyInput) {
                        keyInput.focus();
                        keyInput.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                saveGeminiKey(true);
                            }
                        });
                    }
                }, 100);
            }
        }

        // Hide the change API key form
        function hideChangeKeyForm() {
            const changeForm = document.getElementById('change-key-form');
            const changeBtn = document.getElementById('change-key-btn');
            const keyInput = document.getElementById('gemini-key-input-change');
            
            if (changeForm && changeBtn) {
                changeForm.style.display = 'none';
                changeBtn.style.display = 'inline-block';
                
                // Clear the input field
                if (keyInput) {
                    keyInput.value = '';
                }
            }
        }

        // Test Gemini API key
        async function testGeminiAPI() {
            try {
                testButton.disabled = true;
                testSpinner.style.display = 'inline-block';
                testResult.innerHTML = '';
                
                const response = await fetch(`${GEMINI_API_BASE}/config/gemini`);
                const data = await response.json();
                
                displayTestResult(data);
                
            } catch (error) {
                displayTestResult({
                    success: false,
                    message: 'Failed to connect to API server',
                    error: error.message,
                    api_key_present: false
                });
            } finally {
                testButton.disabled = false;
                testSpinner.style.display = 'none';
            }
        }

        // Display test results
        function displayTestResult(result) {
            const resultClass = result.success ? 'success-message' : 'error-message';
            const icon = result.success ? '✅' : '❌';
            
            let html = `
                <div class="${resultClass}">
                    <h4>${icon} ${result.message}</h4>
                    <div class="details">
API Key Present: ${result.api_key_present ? 'Yes' : 'No'}`;
            
            if (result.api_key_preview) {
                html += `\nAPI Key Preview: ${result.api_key_preview}`;
            }
            
            if (result.error) {
                html += `\nError Details: ${result.error}`;
            }
            
            if (result.success) {
                html += `\nStatus: API key is valid and working
Test: Successfully connected to Gemini API
Ready: AI features are available`;
                
                // Hide test button and show analyze data button
                testButton.style.display = 'none';
                document.getElementById('analyze-data').style.display = 'inline-block';
            }
            
            html += `
                    </div>
                </div>
            `;
            
            testResult.innerHTML = html;
        }

        // Event listeners
        testButton.addEventListener('click', testGeminiAPI);

        // Use shared OS detection panel from team/js/common.js
        createOSDetectionPanel('os-detection-container');

        // Use shared combined Rust API Status panel from team/js/common.js
        createRustApiStatusPanel('combined-rust-api-container', false);

        // Setup webroot setup content and Git account fields
        if (typeof setupWebrootSetup === 'function') {
            setupWebrootSetup('webrootSetup');
        }
        if (typeof setupGitAccountFields === 'function') {
            setupGitAccountFields('gitAccountFieldsContainer');
        } else {
            console.error('setup functions not available');
        }
        
        // Initialize page
        updateWebServerPanel(); // Check web server status
        loadConfiguration();
        
        // Use shared processPCContent function from team/js/common.js
        function processServerPCContent() {
            const osSelect = document.getElementById('os');
            const osValue = osSelect ? osSelect.value : null;
            processPCContent(osValue);
        }
        
        // Load README without logging to keep the interface clean
        displayFile("README.md", "readmeDiv", "_parent", null, false, processServerPCContent);
    </script>
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        // Initialize Feather Icons
        feather.replace();
    </script>
</body>
</html>